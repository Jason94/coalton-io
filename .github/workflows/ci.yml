name: CI

on:
  pull_request:
    branches:
      - master
      - main
  push:
    branches:
      - master
      - main
  workflow_dispatch:
  schedule:
    # Weekly sanity-check (Mondays at 05:00 UTC)
    - cron: '0 5 * * 1'

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Tests (SBCL)
    runs-on: ubuntu-latest
    env:
      LISP: sbcl-bin
      # Helps Qlot avoid GitHub API rate-limits when fetching tarballs.
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preload named-readtables (Roswell workaround)
        run: |
          set -euxo pipefail
          mkdir -p ~/.roswell/local-projects
          rm -rf ~/.roswell/local-projects/named-readtables
          git clone --depth 1 --branch master \
            https://github.com/melisgl/named-readtables.git \
            ~/.roswell/local-projects/named-readtables

      - name: Setup Common Lisp (Roswell + Qlot)
        uses: 40ants/setup-lisp@v4
        with:
          # Disable internal caching so it can't overwrite the preloaded local-projects checkout above.
          cache: false
          qlfile-template: |
            dist ultralisp http://dist.ultralisp.org/
            dist quicklisp https://beta.quicklisp.org/dist/quicklisp.txt
            github named-readtables melisgl/named-readtables :branch master
            github coalton coalton-lang/coalton :branch main
            github coalton-threads garlic0x1/coalton-threads

      - name: Run tests
        uses: 40ants/run-tests@v2
        with:
          asdf-system: coalton-io

      - name: Load examples
        run: |
          qlot exec ros run --non-interactive \
            --eval '(progn
              (require :asdf)
              (asdf:load-asd "coalton-io.asd")
              (asdf:load-system :coalton-io/examples)
              (format t "~&Loaded coalton-io/examples successfully.~%")
              (uiop:quit 0))'
        shell: lispsh -eo pipefail {0}
